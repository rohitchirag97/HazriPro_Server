version: '3.8'

services:
  # 1. Nginx Proxy Manager (Handles 80/443, SSL, and Routing)
  nginx:
    # Use the specialized image for easy SSL/Reverse Proxy
    image: jc21/nginx-proxy-manager:latest 
    container_name: nginx_proxy
    ports:
      - 80:80    # Public HTTP
      - 443:443  # Public HTTPS
      - 81:81    # Admin Web UI (access via http://VM_IP:81)
    # depends_on is not needed if 'app' uses 'restart: always'
    restart: always
    volumes:
      - ./data:/data
      - ./letsencrypt:/etc/letsencrypt
    networks:
      - hazri-network

  # 2. Your Node.js Backend Application
  app:
    # CRITICAL FIX: Use 'image:' to pull from Docker Hub
    image: rohitchirag97/hazripro-api:latest 
    container_name: hazripro-api
    # Only expose the port internally to the proxy
    expose:
      - ${PORT:-8000} 
    # Remove public 'ports:' entry
    env_file:
      - .env
    environment:
      - REDIS_HOST=hazri-redis
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@hazri-postgres:5432/${POSTGRES_DB:-postgres}
    depends_on:
      - hazri-redis
      - hazri-postgres
    restart: always
    networks:
      - hazri-network

  # 3. Redis Cache Service (Internal Only)
  hazri-redis:
    image: redis:7-alpine
    container_name: hazri-redis
    # SECURITY FIX: REMOVED 'ports:' to keep it private
    volumes:
      # FIX: Correct volume mapping for redis
      - redis_data:/data 
    restart: always
    networks:
      - hazri-network

  # 4. PostgreSQL Database Service (Internal Only)
  hazri-postgres:
    image: postgres:16-alpine
    container_name: hazri-postgres
    # SECURITY FIX: REMOVED 'ports:' and kept it private
    env_file:
      - .env
    volumes:
      # FIX: Correct volume mapping for postgres
      - postgres_data:/var/lib/postgresql/data 
    restart: always
    networks:
      - hazri-network

networks:
  hazri-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data: